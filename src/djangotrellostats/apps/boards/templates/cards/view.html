{% extends "boards/view.html" %}

{% load humanize %}
{% load staticfiles %}

{% block css %}
    {{block.super}}
    <link href="{% static 'css/boards/cards/view.css' %}" rel="stylesheet" />
{% endblock css %}

{% block page_title %}{{card.name}}{% endblock %}

{% block content %}
    <div class="panel panel-default">
      <div class="panel-heading">
          <h1>{{card.name}}</h1>
      </div>
      <div class="panel-body">
          <div>
              <div>Created on {{card.creation_datetime}}</div>
              <div class="card-status">
                  {% if card.is_closed %}
                    <span class="fa fa-lock" title="This card is closed"></span> Closed
                  {% else %}
                    <span class="fa fa-unlock" title="This card is active"></span> Active
                  {% endif %}
              </div>

              <div class="row card-list-environment">
                  {% if member and previous_list %}
                    <div class="col-md-4 move_backward">
                        <form action="{% url 'boards:move_card_backward' board.id card.id %}" name="move_backward" method="post">
                            <button type="submit" class="btn btn-danger" title="Move backwards to {{previous_list.name}}">
                                <span class="fa fa-arrow-left"></span>
                                {{previous_list.name|truncatechars:40}}
                            </button>
                        </form>
                    </div>
                  {% endif %}

                  <div class="col-md-4 list  card-current-list label {% if list.type == 'done' %}label-success{% else %}label-primary{% endif %}">
                        On list <strong>{{list.name}} {% if list.type == "done" %}<span class="fa fa-thumbs-up"></span>{% endif %}</strong>
                  </div>

                  {% if member and next_list %}
                    <div class="col-md-4 move_forward">
                      <form action="{% url 'boards:move_card_forward' board.id card.id %}" name="move_forward" method="post">
                        <button type="submit" class="btn btn-success" title="Move forward to {{next_list.name}}">
                            {{next_list.name|truncatechars:40}}
                            <span class="fa fa-arrow-right"></span>
                        </button>
                      </form>
                    </div>
                  {% endif %}
              </div>

              <div class="card-labels">
                  {% if labels %}
                    {% for label in labels %}<span>{{label.name}}</span>{% endfor %}
                  {% else %}
                    <em>Without labels.</em>
                  {% endif %}
                </div>

              <div class="card-blocking_cards">
                  {% if card.pending_blocking_cards.exists %}
                        {% for blocking_card in card.pending_blocking_cards %}
                            <a href="{% url 'boards:view_card' board.id blocking_card.id %}" title="View blocking card {{blocking_card.name}}">
                                {{blocking_card.name}}
                            </a>
                            {% if forloop.revcounter > 2 %}, {% elif forloop.revcounter > 1 %} & {% endif %}
                        {% endfor %}
                  {% else %}
                        <em>No other cards are blocking this one.</em>
                  {% endif %}

              </div>

              <div class="card-members">
                  <h2>Members ({{members|length}})</h2>
                  {% if members|length > 0 %}
                    <ul>
                        {% for member_i in members %}
                            <li>{{member.trello_username}}</li>
                        {% endfor %}
                    </ul>
                  {% else %}
                    This task has no assigned members.
                  {% endif %}
              </div>

          {% if card.spent_time %}
              <div class="spent_time">
                  <h2>Spent time</h2>
                  <div>{{card.spent_time}} hours</div>
              </div>
          {% endif %}
          {% if card.cycle_time %}
              <div class="cycle_time">
                  <h2>Cycle time</h2>
                  <div>{{card.cycle_time}} hours</div>
              </div>
          {% endif %}
          {% if card.lead_time %}
              <div class="lead_time ">
                  <h2>Lead time</h2>
                  <div>{{card.lead_time}} hours</div>
              </div>
          {% endif %}
          <div class="description">
              <h2>Content</h2>
              {% if card.description %}
                {{card.description}}
              {% else %}
                <em>No description.</em>
              {% endif %}
          </div>

          <div class="card-charts">
              <h2>Stats</h2>
              <div class="row">
                    <div class="col-sm-6">
                        <a href="{% url 'charts:number_of_comments_by_member' board.id card.id %}" title="Number of comments by member">
                            <img src="{% url 'charts:number_of_comments_by_member' board.id card.id %}" alt="Number of comments by member"/>
                        </a>
                    </div>
                    <div class="col-sm-6">
                        <a href="{% url 'charts:number_of_comments' board.id card.id %}" title="Evolution of number of comments of this card thru time">
                            <img src="{% url 'charts:number_of_comments' board.id card.id %}" alt="Evolution of number of comments of this card thru time"/>
                        </a>
                    </div>
                </div>
          </div>

          <div class="card-comments">
              <h2>Comments ({{comments|length}})</h2>
              <div>
                  {% if comments|length == 0 %}
                    <em>No comments yet.</em>
                  {% else %}
                      {% for comment in comments %}
                          <div class="panel panel-info">
                              <div class="panel-heading">
                                  Comment made by {{comment.author.initials}}
                                  (<span title="Comment made by {{comment.creation_datetime}}">{{comment.creation_datetime|naturaltime}}</span>)
                              </div>
                              <div class="panel-body">
                                  {{comment.content}}
                              </div>
                          </div>
                      {% endfor %}
                  {% endif %}
              </div>
          </div>
      </div>
    </div>
{% endblock content %}